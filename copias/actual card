
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const response = await fetch('/albums');
    console.log('Raw response:', response);

    if (!response.ok) throw new Error('No se pudieron obtener los álbumes');

    const albums = await response.json();
    console.log('Álbumes recibidos:', albums);
    renderAlbums(albums);
  } catch (error) {
    console.error(error);
    document.getElementById('albumGallery').innerHTML = '<p>Error al cargar los álbumes.</p>';
  }
});

function renderAlbums(albums) {
  albumGallery.innerHTML = '';

  if (!albums || albums.length === 0) {
    albumGallery.innerHTML = '<p>No hay álbumes disponibles</p>';
    return;
  }

  albums.forEach(album => {
    const albumCard = document.createElement('div');
    albumCard.className = 'album-card';

    const coverUrl = album.coverUrl || '/placeholder.jpg'; // <-- imagen del backend o default

    albumCard.innerHTML = `
          <img src="${coverUrl}" 
               alt="${album.title}" 
               class="album-cover"
               onerror="this.onerror=null; this.src='/placeholder.jpg';">
          <h3>${album.title}</h3>
          <p>${album.artist_name}</p>
          <div class="album-menu" data-id="${album._id}">
        <div class="album-menu-dots">
          <div class="album-menu-dot"></div>
          <div class="album-menu-dot"></div>
          <div class="album-menu-dot"></div>
        </div>
      </div>
      <div class="album-dropdown" id="dropdown-${album._id}">
        <div class="dropdown-item edit-album" data-id="${album._id}">Edit</div>
        <div class="dropdown-item delete-album" data-id="${album._id}">Delete</div>
      </div>
        `;
    albumGallery.appendChild(albumCard);

  });

  // Inicializar los menús después de crear todas las tarjetas
  initAlbumMenus();

}

// Función para inicializar los menús de opciones
function initAlbumMenus() {
  // Menú toggle
  document.querySelectorAll('.album-menu').forEach(menu => {
    menu.addEventListener('click', (e) => {
      e.stopPropagation();
      const albumId = menu.getAttribute('data-id');
      const dropdown = document.getElementById(`dropdown-${albumId}`);

      // Cerrar todos los demás dropdowns
      document.querySelectorAll('.album-dropdown.active').forEach(d => {
        if (d.id !== `dropdown-${albumId}`) {
          d.classList.remove('active');
        }
      });

      dropdown.classList.toggle('active');
    });
  });

  // Editar álbum
  document.querySelectorAll('.edit-album').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const albumId = btn.getAttribute('data-id');

      try {
        const response = await fetch(`/album/${albumId}`);
        if (!response.ok) {
          throw new Error('No se pudo obtener el álbum');
        }


        const album = await response.json();

        console.log(album);
        openEditModal(album);

        // Manejar la imagen de portada
        if (album.coverUrl) {
          coverPreview.src = album.coverUrl;
          coverPreview.style.display = 'block';
        } else {
          coverPreview.src = '#';
          coverPreview.style.display = 'none';
        }
      } catch (error) {
        console.error('Error al obtener detalles del álbum:', error);
        alert('Error al cargar los detalles del álbum');
      }
    });
  });

  // Eliminar álbum
  document.querySelectorAll('.delete-album').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const albumId = btn.getAttribute('data-id');

      if (confirm('¿Estás seguro de que quieres eliminar este álbum?')) {
        try {
          const response = await fetch(`/album/${albumId}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            throw new Error('No se pudo eliminar el álbum');
          }

          // Recargar los álbumes
          //refreshAlbums();

          alert('¡Álbum eliminado con éxito!');
        } catch (error) {
          console.error('Error al eliminar el álbum:', error);
          alert('Error al eliminar el álbum');
        }
      }
    });
  });

  // Cerrar dropdowns al hacer clic en cualquier otro lugar
  document.addEventListener('click', () => {
    document.querySelectorAll('.album-dropdown.active').forEach(dropdown => {
      dropdown.classList.remove('active');
    });
  });
}
// ------- HAsta aqui la funcion cardas

