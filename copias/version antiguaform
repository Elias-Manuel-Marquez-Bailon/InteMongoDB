const form = document.getElementById('albumForm');
const fileUploadArea = document.getElementById('fileUploadArea');
const coverImageInput = document.getElementById('coverImageInput');
const coverPreview = document.getElementById('coverPreview');
const songsContainer = document.getElementById('songsContainer');
const addSongBtn = document.getElementById('addSongBtn');
const submitBtn = form.querySelector('.submit-btn');

let currentAlbumId = null; // Usar let en lugar de const para poder modificarlo

// ===== Funciones =====

// Manejo de la subida de imagen
fileUploadArea.addEventListener('click', () => {
    coverImageInput.click();
});

coverImageInput.addEventListener('change', handleImagePreview);

function handleImagePreview() {
    const file = coverImageInput.files[0];
    if (file) {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            coverPreview.src = e.target.result;
            coverPreview.style.display = 'block';
        };
        
        reader.readAsDataURL(file);
    } else {
        coverPreview.src = '#';
        coverPreview.style.display = 'none';
    }
}

// Manejo de canciones
function updatePlaceholders() {
    const inputs = songsContainer.querySelectorAll('input[name="songs[]"]');
    inputs.forEach((input, i) => {
        input.placeholder = `Canción ${i + 1}`;
    });
}

function createSongInput() {
    const div = document.createElement('div');
    div.className = 'song-input';

    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'songs[]';
    input.required = true;

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'removeSongBtn';
    removeBtn.textContent = '🗑️';
    removeBtn.addEventListener('click', () => {
        div.remove();
        updatePlaceholders();
    });

    div.appendChild(input);
    div.appendChild(removeBtn);
    return div;
}

addSongBtn.addEventListener('click', () => {
    songsContainer.appendChild(createSongInput());
    updatePlaceholders();
});

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Mostrar estado de carga
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';
  
    try {
      const formData = new FormData(form);
      const response = await fetch('/newalbum', {
        method: 'POST',
        body: formData
      });
  
      if (response.ok) {
        const result = await response.json();
        alert(result.message || 'Álbum creado exitosamente');

        resetAlbumForm();
 
        if (typeof loadAlbums === 'function') {
          loadAlbums();
        }
      } else {
        const error = await response.json();
        throw new Error(error.message || 'Error al crear el álbum');
      }
    } catch (error) {
      console.error('Error:', error);
      alert(error.message || 'Error al procesar la solicitud');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalBtnText;
    }
  });
  
  // Inicializar con un campo de canción
  window.addEventListener('DOMContentLoaded', () => {
    songsContainer.innerHTML = '';
    songsContainer.appendChild(createSongInput());
  });


function resetAlbumForm() {
    const form = document.getElementById('albumForm');
    if (!form) return;
    
    form.reset();

    if (coverPreview) {
      coverPreview.src = '#';
      coverPreview.style.display = 'none';
    }
 
    if (songsContainer) {
      songsContainer.innerHTML = '';
      songsContainer.appendChild(createSongInput());
        updatePlaceholders(); 
      
    }

    if (coverImageInput) {
      coverImageInput.value = '';
    }
    currentAlbumId = null;
  }

